import I from'fs';import n from'yt-search';import d from'node-fetch';import{interactiveUtils}from'../src/libraries/base/interactive.js';const configContent=I['readFileSync']('./config.js','utf-8');if(!configContent['includes']('Luna-Botv6'))throw new Error('Handler\x20bloqueado');const APIS=[{'url':'https://api.stellarwa.xyz','key':'paymonbest','type':'stellar'},{'url':'https://noobs-api.top','type':'fallback'}];function bar(F){const A=0xa;return'ğŸŸ©'['repeat'](F)+'â¬œ'['repeat'](A-F);}async function sendProgress(F,A,h){try{return await F['sendMessage'](A['chat'],{'text':h},{'quoted':A});}catch(g){return console['error']('Error\x20enviando\x20progreso:',g['message']),null;}}async function editProgress(F,A,h){try{if(!A||!A['remoteJid'])return null;return await F['sendMessage'](A['remoteJid'],{'text':h,'edit':A});}catch(g){return console['error']('Error\x20editando\x20progreso:',g['message']),null;}}async function fetchBuffer(F){const A=await d(F);return await A['buffer']();}async function fetchWithAPIs(F,A,h='128'){for(const g of APIS){try{let t;if(g['type']==='stellar'){const u={'mp3':'128','mp4':'360'},c=u[A]||h,D=A==='mp3'?'/dl/ytmp3':'/dl/ytmp4';t=''+g['url']+D+'?url='+encodeURIComponent(F)+'&key='+g['key']+'&quality='+c;}else t=g['url']+'/dipto/ytDl3?link='+encodeURIComponent(F)+'&format='+A;const E=new AbortController(),K=setTimeout(()=>E['abort'](),0x4e20),X=await d(t,{'signal':E['signal']});clearTimeout(K);if(!X['ok'])continue;const v=await X['json']();if(g['type']==='stellar'){if(!v['status']||!v['data']||!v['data']['dl'])continue;return{'downloadLink':v['data']['dl'],'title':v['data']['title']||'Media'};}else{if(!v['downloadLink'])continue;return{'downloadLink':v['downloadLink'],'title':v['title']||'Media'};}}catch(N){continue;}}throw new Error('âŒ\x20Todas\x20las\x20APIs\x20fallaron');}async function downloadMedia(F,A,h,g){let t=null;try{const E=g['match'](/v=([^&]+)/)?.[0x1]||g['replace']('https://youtu.be/',''),K=Date['now'](),X=await sendProgress(F,A,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x1)+'\x0aâ³\x20Preparando\x20descarga');if(!X)throw new Error('No\x20se\x20pudo\x20enviar\x20mensaje\x20de\x20progreso');t=X['key'];const v=h==='ytmp3'?'mp3':'mp4',u=h==='ytmp3low'?'128':h==='ytmp4'?'360':'192';await editProgress(F,t,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x4)+'\x0aâ¬‡ï¸\x20Descargando\x20archivo');const c=await fetchWithAPIs(g,v,u);if(!c['downloadLink']){await editProgress(F,t,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0aâŒ\x20Error\x20al\x20descargar');return;}await editProgress(F,t,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x7)+'\x0ağŸ“¦\x20Procesando\x20archivo');const D=c['downloadLink']['includes']('.m3u8');if(h==='ytmp3'||h==='ytmp3low')try{if(D)throw new Error('Formato\x20M3U8');await F['sendMessage'](A['chat'],{'audio':{'url':c['downloadLink']},'mimetype':'audio/mpeg','fileName':(c['title']||'audio')+'.mp3','ptt':![]},{'quoted':A});}catch{const H=await fetchBuffer(c['downloadLink']);await F['sendMessage'](A['chat'],{'audio':H,'mimetype':'audio/mpeg','fileName':(c['title']||'audio')+'.mp3','ptt':![]},{'quoted':A});}if(h==='ytmp4')try{if(D)throw new Error('Formato\x20M3U8');await F['sendMessage'](A['chat'],{'video':{'url':c['downloadLink']},'mimetype':'video/mp4','caption':c['title']||'ğŸ¬\x20Video'},{'quoted':A});}catch{const l=await fetchBuffer(c['downloadLink']);await F['sendMessage'](A['chat'],{'video':l,'mimetype':'video/mp4','caption':c['title']||'ğŸ¬\x20Video'},{'quoted':A});}const N=((Date['now']()-K)/0x3e8)['toFixed'](0x2),U=h==='ytmp4'?'ğŸ¬\x20Video':'ğŸµ\x20MÃºsica';await editProgress(F,t,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0xa)+'\x0aâœ…\x20'+U+'\x20descargada\x20en\x20'+N+'s\x0ağŸ“\x20'+c['title']);}catch(b){console['error']('Error\x20en\x20downloadMedia:',b['message']);try{await F['reply'](A['chat'],'âŒ\x20Error:\x20'+b['message'],A);}catch(T){console['error']('Error\x20enviando\x20mensaje\x20de\x20error:',T['message']);}}}let handler=async(F,{conn:A,text:h,command:g,usedPrefix:t})=>{try{if(g==='play'){if(!h)return A['reply'](F['chat'],'Escribe\x20el\x20nombre\x20de\x20la\x20canciÃ³n',F);try{const E=await n(h),K=E['videos']?.[0x0];if(!K)return A['reply'](F['chat'],'No\x20se\x20encontrÃ³\x20la\x20canciÃ³n',F);const X='https://youtu.be/'+K['videoId'],v=[['ğŸµ\x20Audio\x20(RÃ¡pido)',t+'ytmp3low\x20'+X],['ğŸµ\x20Audio',t+'ytmp3\x20'+X],['ğŸ¬\x20Video',t+'ytmp4\x20'+X]];await interactiveUtils['sendNCarousel'](A,F['chat'],'ğŸ¶\x20*'+K['title']+'*\x0ağŸ‘¤\x20'+K['author']?.['name']+'\x0aâ±ï¸\x20'+K['timestamp'],'Luna-Bot',K['thumbnail'],v,null,null,null,F,{});}catch(u){console['error']('Error\x20en\x20play:',u['message']),A['reply'](F['chat'],'âŒ\x20Error\x20en\x20bÃºsqueda:\x20'+u['message'],F);}}if(g==='ytmp3'||g==='ytmp4'||g==='ytmp3low'){if(!h)return A['reply'](F['chat'],'Falta\x20el\x20enlace',F);await downloadMedia(A,F,g,h);}}catch(c){console['error']('Error\x20crÃ­tico\x20en\x20handler:',c['message']);}};handler['command']=['play','ytmp3','ytmp3low','ytmp4'],handler['tags']=['downloader'],handler['help']=['play\x20nombre','ytmp3\x20url','ytmp3low\x20url','ytmp4\x20url'];export default handler;

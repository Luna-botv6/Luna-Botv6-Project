import w from'fs';import Q from'yt-search';import E from'node-fetch';const configContent=w['readFileSync']('./config.js','utf-8');if(!configContent['includes']('Luna-Botv6'))throw new Error('Handler\x20bloqueado');const APIS=[{'url':'https://api.stellarwa.xyz','key':'paymonbest','type':'stellar'},{'url':'https://noobs-api.top','type':'fallback'}];function bar(V){const R=0xa;return'ğŸŸ©'['repeat'](V)+'â¬œ'['repeat'](R-V);}async function sendProgress(V,R,P){return await V['sendMessage'](R['chat'],{'text':P},{'quoted':R});}async function editProgress(V,R,P){return await V['sendMessage'](R['remoteJid'],{'text':P,'edit':R});}async function fetchBuffer(V){const R=await E(V);return await R['buffer']();}async function fetchWithAPIs(V,R,P='128'){for(const X of APIS){try{let S;if(X['type']==='stellar'){const z={'mp3':'128','mp4':'360'},d=z[R]||P,I=R==='mp3'?'/dl/ytmp3':'/dl/ytmp4';S=''+X['url']+I+'?url='+encodeURIComponent(V)+'&key='+X['key']+'&quality='+d;}else S=X['url']+'/dipto/ytDl3?link='+encodeURIComponent(V)+'&format='+R;const t=new AbortController(),N=setTimeout(()=>t['abort'](),0x4e20),y=await E(S,{'signal':t['signal']});clearTimeout(N);if(!y['ok'])continue;const L=await y['json']();if(X['type']==='stellar'){if(!L['status']||!L['data']||!L['data']['dl'])continue;return{'downloadLink':L['data']['dl'],'title':L['data']['title']||'Media'};}else{if(!L['downloadLink'])continue;return{'downloadLink':L['downloadLink'],'title':L['title']||'Media'};}}catch(u){continue;}}throw new Error('âŒ\x20Todas\x20las\x20APIs\x20fallaron');}async function downloadMedia(V,R,P,X){try{const S=X['match'](/v=([^&]+)/)?.[0x1]||X['replace']('https://youtu.be/',''),t=Date['now'](),N=await sendProgress(V,R,'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x1)+'\x0aâ³\x20Preparando\x20descarga'),y=P==='ytmp3'?'mp3':'mp4',L=P==='ytmp3low'?'128':P==='ytmp4'?'360':'192';await editProgress(V,N['key'],'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x4)+'\x0aâ¬‡ï¸\x20Descargando\x20archivo');const z=await fetchWithAPIs(X,y,L);if(!z['downloadLink'])return editProgress(V,N['key'],'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0aâŒ\x20Error\x20al\x20descargar');await editProgress(V,N['key'],'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0x7)+'\x0ağŸ“¦\x20Procesando\x20archivo');const q=z['downloadLink']['includes']('.m3u8');if(P==='ytmp3'||P==='ytmp3low')try{if(q)throw 0x0;await V['sendMessage'](R['chat'],{'audio':{'url':z['downloadLink']},'mimetype':'audio/mpeg','fileName':(z['title']||'audio')+'.mp3','ptt':![]},{'quoted':R});}catch{const u=await fetchBuffer(z['downloadLink']);await V['sendMessage'](R['chat'],{'audio':u,'mimetype':'audio/mpeg','fileName':(z['title']||'audio')+'.mp3','ptt':![]},{'quoted':R});}if(P==='ytmp4')try{if(q)throw 0x0;await V['sendMessage'](R['chat'],{'video':{'url':z['downloadLink']},'mimetype':'video/mp4','caption':z['title']||'ğŸ¬\x20Video'},{'quoted':R});}catch{const c=await fetchBuffer(z['downloadLink']);await V['sendMessage'](R['chat'],{'video':c,'mimetype':'video/mp4','caption':z['title']||'ğŸ¬\x20Video'},{'quoted':R});}const d=((Date['now']()-t)/0x3e8)['toFixed'](0x2),I=P==='ytmp4'?'ğŸ¬\x20Video':'ğŸµ\x20MÃºsica';await editProgress(V,N['key'],'ğŸŒ™ğŸ¤–\x20*LunaBot*\x0a'+bar(0xa)+'\x0aâœ…\x20'+I+'\x20descargada\x20en\x20'+d+'s\x0ağŸ“\x20'+z['title']);}catch(x){await V['reply'](R['chat'],'âŒ\x20Error:\x20'+x['message'],R);}}let handler=async(V,{conn:R,text:P,command:X,usedPrefix:S})=>{if(X==='play'){if(!P)return R['reply'](V['chat'],'Escribe\x20el\x20nombre\x20de\x20la\x20canciÃ³n',V);const t=await Q(P),N=t['videos']?.[0x0];if(!N)return R['reply'](V['chat'],'No\x20se\x20encontrÃ³\x20la\x20canciÃ³n',V);const y='https://youtu.be/'+N['videoId'];await R['sendMessage'](V['chat'],{'image':{'url':N['thumbnail']},'caption':'ğŸ¶\x20*'+N['title']+'*\x0a'+('ğŸ‘¤\x20'+N['author']?.['name']+'\x0a')+('â±ï¸\x20'+N['timestamp']+'\x0a\x0a')+'Selecciona\x20una\x20opciÃ³n:','interactiveButtons':[{'name':'quick_reply','buttonParamsJson':JSON['stringify']({'display_text':'ğŸµ\x20Audio\x20(RÃ¡pido)','id':S+'ytmp3low\x20'+y})},{'name':'quick_reply','buttonParamsJson':JSON['stringify']({'display_text':'ğŸµ\x20Audio','id':S+'ytmp3\x20'+y})},{'name':'quick_reply','buttonParamsJson':JSON['stringify']({'display_text':'ğŸ¬\x20Video','id':S+'ytmp4\x20'+y})}]},{'quoted':V});}if(X==='ytmp3'||X==='ytmp4'||X==='ytmp3low'){if(!P)return R['reply'](V['chat'],'Falta\x20el\x20enlace',V);await downloadMedia(R,V,X,P);}};handler['command']=['play','ytmp3','ytmp3low','ytmp4'],handler['tags']=['downloader'],handler['help']=['play\x20nombre','ytmp3\x20url','ytmp3low\x20url','ytmp4\x20url'];export default handler;
